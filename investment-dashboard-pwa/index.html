<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Invest Dashboard</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">◎</div>
      <div>
        <div class="title">Invest Dashboard</div>
        <div class="subtitle" id="subtitle">Local-first PWA</div>
      </div>
    </div>
    <div class="top-actions">
      <button class="btn ghost" id="btnBackup">Export</button>
      <label class="btn ghost file">
        Import
        <input id="btnRestore" type="file" accept="application/json" />
      </label>
    </div>
  </header>

  <nav class="tabs" role="tablist" aria-label="Sections">
    <button class="tab active" data-view="overview" role="tab">Overview</button>
    <button class="tab" data-view="positions" role="tab">Positions</button>
    <button class="tab" data-view="import" role="tab">CSV Import</button>
    <button class="tab" data-view="settings" role="tab">Settings</button>
  </nav>

  <main class="container">
    <!-- OVERVIEW -->
    <section class="view" id="view-overview">
      <div class="grid">
        <div class="card">
          <div class="card-hd">
            <h2>Portfolio snapshot</h2>
            <div class="pill" id="asof"></div>
          </div>
          <div class="big" id="totalValue">$0</div>
          <div class="muted" id="totalMeta">0 positions · 0 accounts</div>
          <div class="divider"></div>

          <div class="row">
            <div class="kpi">
              <div class="kpi-label">Liquidity runway</div>
              <div class="kpi-value" id="runway">—</div>
              <div class="kpi-help muted">Liquidity ÷ monthly burn</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Sleeve drift</div>
              <div class="kpi-value" id="maxDrift">—</div>
              <div class="kpi-help muted">Largest abs. drift</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-hd">
            <h2>Sleeves</h2>
            <div class="muted">Target vs actual</div>
          </div>
          <div id="sleeveBars" class="bars" aria-label="Sleeve chart"></div>
          <div class="divider"></div>
          <div id="sleeveTable" class="table"></div>
        </div>

        <div class="card">
          <div class="card-hd">
            <h2>Upcoming maturities & calls</h2>
            <div class="muted">Next 120 days</div>
          </div>
          <div id="upcomingList" class="list"></div>
          <div class="divider"></div>
          <div class="card-hd">
            <h2>Monthly review (copy/paste)</h2>
            <button class="btn small" id="btnCopyReview">Copy</button>
          </div>
          <textarea id="reviewText" class="textarea" rows="10" spellcheck="false"></textarea>
          <div class="muted small">Generated from your current data (targets, drift, maturities, actions).</div>
        </div>
      </div>
    </section>

    <!-- POSITIONS -->
    <section class="view hidden" id="view-positions">
      <div class="grid">
        <div class="card">
          <div class="card-hd">
            <h2>Positions</h2>
            <button class="btn" id="btnAddPosition">+ Add</button>
          </div>

          <div class="filters">
            <input id="search" class="input" placeholder="Search (name, issuer, tags)..." />
            <select id="filterSleeve" class="input">
              <option value="">All sleeves</option>
            </select>
            <select id="filterType" class="input">
              <option value="">All types</option>
              <option>Cash</option>
              <option>Term Deposit</option>
              <option>Managed Fund</option>
              <option>ETF</option>
              <option>Shares</option>
              <option>Crypto</option>
              <option>Private</option>
              <option>Other</option>
            </select>
          </div>

          <div id="positionsTable" class="table"></div>
        </div>
      </div>

      <dialog id="dlgPosition" class="dialog">
        <form method="dialog" id="positionForm">
          <div class="dialog-hd">
            <h3 id="dlgTitle">Add position</h3>
            <button class="btn ghost" value="cancel">✕</button>
          </div>

          <div class="form-grid">
            <label>
              <span>Name</span>
              <input class="input" name="name" required placeholder="e.g., Milford Growth Fund" />
            </label>

            <label>
              <span>Sleeve</span>
              <select class="input" name="sleeve" required></select>
            </label>

            <label>
              <span>Type</span>
              <select class="input" name="type" required>
                <option>Cash</option>
                <option>Term Deposit</option>
                <option>Managed Fund</option>
                <option>ETF</option>
                <option>Shares</option>
                <option>Crypto</option>
                <option>Private</option>
                <option>Other</option>
              </select>
            </label>

            <label>
              <span>Institution / Issuer</span>
              <input class="input" name="issuer" placeholder="e.g., Milford / BNZ" />
            </label>

            <label>
              <span>Current value (NZD)</span>
              <input class="input" name="value" type="number" inputmode="decimal" step="0.01" required />
            </label>

            <label>
              <span>Cost / principal (NZD)</span>
              <input class="input" name="cost" type="number" inputmode="decimal" step="0.01" />
            </label>

            <label>
              <span>Currency</span>
              <input class="input" name="currency" value="NZD" />
            </label>

            <label>
              <span>Maturity / call date (optional)</span>
              <input class="input" name="maturity" type="date" />
            </label>

            <label>
              <span>Expected rate % p.a. (optional)</span>
              <input class="input" name="rate" type="number" inputmode="decimal" step="0.01" placeholder="e.g., 5.25" />
            </label>

            <label class="span2">
              <span>Tags (comma-separated)</span>
              <input class="input" name="tags" placeholder="e.g., TD, ladder, growth" />
            </label>

            <label class="span2">
              <span>Notes</span>
              <textarea class="textarea" name="notes" rows="3" placeholder="Anything you want to remember..."></textarea>
            </label>
          </div>

          <div class="dialog-ft">
            <button class="btn danger" id="btnDelete" type="button">Delete</button>
            <div class="spacer"></div>
            <button class="btn ghost" value="cancel">Cancel</button>
            <button class="btn" value="ok">Save</button>
          </div>
        </form>
      </dialog>
    </section>

    <!-- IMPORT -->
    <section class="view hidden" id="view-import">
      <div class="grid">
        <div class="card">
          <div class="card-hd">
            <h2>CSV import</h2>
            <div class="muted">Positions or balances — local only</div>
          </div>

          <div class="callout">
            <div class="callout-title">Recommended templates</div>
            <div class="muted small">
              Use these headers (case-insensitive). Extra columns are ignored.
            </div>
            <ul class="small">
              <li><b>Positions CSV</b>: name, sleeve, type, issuer, value_nzd, cost_nzd, currency, maturity_date, expected_rate, tags, notes</li>
              <li><b>Balances CSV</b>: account, sleeve, value_nzd, as_of (YYYY-MM-DD), notes</li>
            </ul>
          </div>

          <div class="row">
            <label class="radio">
              <input type="radio" name="importMode" value="positions" checked />
              <span>Import as Positions</span>
            </label>
            <label class="radio">
              <input type="radio" name="importMode" value="balances" />
              <span>Import as Cash/Balances</span>
            </label>
          </div>

          <label class="btn file">
            Choose CSV
            <input id="csvFile" type="file" accept=".csv,text/csv" />
          </label>

          <div class="divider"></div>
          <div class="card-hd">
            <h2>Preview</h2>
            <div class="muted">First 25 rows</div>
          </div>
          <div id="importPreview" class="table"></div>

          <div class="divider"></div>
          <div class="row">
            <button class="btn" id="btnCommitImport" disabled>Commit import</button>
            <button class="btn ghost" id="btnClearImport">Clear</button>
            <div class="spacer"></div>
            <div class="muted small" id="importStatus">No file loaded.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="view hidden" id="view-settings">
      <div class="grid">
        <div class="card">
          <div class="card-hd">
            <h2>Sleeve targets</h2>
            <div class="muted">Must sum to 100%</div>
          </div>
          <div id="targetsForm" class="targets"></div>
          <div class="row">
            <button class="btn" id="btnSaveTargets">Save targets</button>
            <button class="btn ghost" id="btnResetTargets">Reset defaults</button>
            <div class="spacer"></div>
            <div id="targetsHint" class="muted small"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-hd">
            <h2>Runway settings</h2>
            <div class="muted">Used for liquidity runway only</div>
          </div>
          <div class="form-grid">
            <label>
              <span>Monthly burn (NZD)</span>
              <input class="input" id="monthlyBurn" type="number" inputmode="decimal" step="0.01" placeholder="e.g., 12000" />
            </label>
            <label>
              <span>Runway uses sleeve</span>
              <select class="input" id="runwaySleeve"></select>
            </label>
          </div>
          <div class="row">
            <button class="btn" id="btnSaveRunway">Save runway settings</button>
            <div class="spacer"></div>
            <div class="muted small">Tip: set runway sleeve to Liquidity (default).</div>
          </div>
        </div>

        <div class="card">
          <div class="card-hd">
            <h2>Data safety</h2>
            <div class="muted">Everything is stored on-device (LocalStorage)</div>
          </div>
          <div class="row">
            <button class="btn danger" id="btnWipe">Wipe all data</button>
            <div class="muted small">Use Export first if you want a backup.</div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer class="footer">
    <div class="muted small">Add to Home Screen on iPhone for an app-like experience · Works offline after first load.</div>
  </footer>

  <script src="app.js"></script>
</body>
</html>
